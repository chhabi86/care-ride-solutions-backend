name: Backend Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'src/**'
      - 'nginx/**'
      - 'deploy/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch, tag, or commit) to deploy'
        required: false
        default: 'main'
      run_healthcheck:
        type: boolean
        required: false
        default: true
        description: 'Run post-deploy healthcheck'

concurrency:
  group: backend-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    env:
      DOMAIN: ${{ secrets.DOMAIN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || 'main' }}

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Known Hosts (Optional Strict)
        run: |
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Sync Repo to Remote
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "set -euo pipefail; if [ ! -d /opt/backend ]; then sudo mkdir -p /opt/backend; sudo chown ${{ secrets.DEPLOY_USER }} /opt/backend; fi"
          rsync -az --delete --exclude 'target/' ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/backend/repo/

      - name: Remote Build & Restart
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "set -euo pipefail; cd /opt/backend/repo; if [ -x ./mvnw ]; then ./mvnw -q clean package -DskipTests || mvn -q clean package -DskipTests; else mvn -q clean package -DskipTests; fi; cp target/*.war /opt/backend/app.war; sudo systemctl restart care-ride-backend"

      - name: Deploy Nginx Config & Environment
        run: |
          # Run post-deploy script to configure nginx and environment
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "set -euo pipefail; cd /opt/backend/repo; MAIL_HOST='${{ secrets.MAIL_HOST || 'smtp.mail.us-east-1.awsapps.com' }}' MAIL_PORT='${{ secrets.MAIL_PORT || '587' }}' MAIL_USERNAME='${{ secrets.MAIL_USERNAME }}' MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}' MAIL_FROM='${{ secrets.MAIL_FROM || 'noreply@careridesolutionspa.com' }}' MAIL_STARTTLS='${{ secrets.MAIL_STARTTLS || 'true' }}' MAIL_AUTH='${{ secrets.MAIL_AUTH || 'true' }}' ./deploy/scripts/post-deploy.sh"

      - name: Post-Deploy Healthcheck
        if: inputs.run_healthcheck != false
        run: |
          D=${DOMAIN:-careridesolutionspa.com}
          echo "Testing health endpoint..."
          for i in {1..15}; do
            STATUS=$(curl -fsS -o /dev/null -w '%{http_code}' http://$D/api/actuator/health || echo "000")
            if [ "$STATUS" = "200" ]; then echo "✓ Health endpoint OK (200)"; break; fi
            echo "Attempt $i: health status=$STATUS"; sleep 4;
          done
          
          echo "Testing contact endpoint..."
          CONTACT_STATUS=$(curl -fsS -o /dev/null -w '%{http_code}' -X POST http://$D/api/contact \
            -H "Content-Type: application/json" \
            -d '{"name":"Deploy Test","phone":"123","email":"test@test.com","reason":"Deploy Test","message":"Automated test"}' || echo "000")
          
          if [ "$CONTACT_STATUS" = "200" ]; then
            echo "✓ Contact endpoint OK (200) - emails should work"
          elif [ "$CONTACT_STATUS" = "404" ]; then
            echo "✗ Contact endpoint still 404 - nginx /api path issue"
            exit 1
          else
            echo "⚠ Contact endpoint status: $CONTACT_STATUS (may need email config)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Backend Deploy" >> $GITHUB_STEP_SUMMARY
          echo "Ref: ${{ inputs.ref }}" >> $GITHUB_STEP_SUMMARY
